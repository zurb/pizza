var Pizza={version:"0.2.2",settings:{type:"pie",donut:false,donut_inner_ratio:.4,percent_offset:35,show_text:true,animation_speed:500,always_show_text:false,show_grid:true,bar_spacer:100,bar_intervals:6,animation_type:"elastic"},NS:"http://www.w3.org/2000/svg",init:function(e,t){var n=this;this.scope=e||document.body;var r=$("[data-chart]",this.scope);$.extend(true,this.settings,t);if(r.length>0){r.each(function(){return n.build($(this),t)})}else if($(this.scope).is("[data-chart]")){this.build($(this.scope),t)}this.events()},events:function(){var e=this;$(window).off(".pizza").on("resize.pizza",e.throttle(function(){e.init()},500));$(this.scope).off(".pizza");this.pie_events();this.line_events();this.bar_events()},build:function(e,t){e.data("settings",$.extend({},this.settings,t,e.data("options")));this.data(e,t||{});if(e.data("options").type=="pie"){this.update_DOM(this.pie(e))}else if(e.data("options").type=="line"){this.update_DOM(this.line(e))}else if(e.data("options").type=="bar"){this.update_DOM(this.bar(e))}},data:function(e,t){var n=[],r=0;$("li",e).each(function(){var e=$(this);if(t.data){n.push({value:t.data[e.index()],text:e.data("text"),color:e.css("color"),segment:e})}else{n.push({x:e.data("x"),y:e.data("y"),value:e.data("value"),text:e.data("text"),color:e.css("color"),segment:e})}});return e.data("graph-data",n)},update_DOM:function(e){var t=e[0],n=e[1];return $(this.identifier(t)).html(n)},animate:function(e,t,n,r,i){var s=this,i=i||1.05;e.hover(function(e){var s=Snap(e.target),o=Snap(s.node.nextSibling);s.animate({transform:"s"+i+" "+i+" "+t+" "+n},r.animation_speed,mina[r.animation_type]);if(!/text/.test(o.node.nodeName))return;o.touchend(function(){Snap(s).animate({transform:"s"+i+" "+i+" "+t+" "+n},r.animation_speed,mina[r.animation_type])});if(r.show_text){o.animate({opacity:1},r.animation_speed);o.touchend(function(){o.animate({opacity:1},r.animation_speed)})}},function(e){var i=Snap(e.target),s=Snap(i.node.nextSibling);i.animate({transform:"s1 1 "+t+" "+n},r.animation_speed,mina[r.animation_type]);if(!/text/.test(s.node.nodeName))return;s.animate({opacity:0},r.animation_speed)})},parse_options:function(e,t,n){var r=t.toFixed(1)+"%",i=e.replace(/{{ *percent *}}/ig,r).replace(/{{ *value *}}/ig,n);return i},svg:function(e,t){var n=$(this.identifier(e)),r=$("svg",n),i=n.width(),s=e.attr("data-chart"),o=n.height();if(r.length>0){r=r[0]}else{var r=this.svg_obj("svg");r.width=i;r.height=o}if(s){var u="-"+t.percent_offset+" -"+t.percent_offset+" "+(i+t.percent_offset*1.5)+" "+(i+t.percent_offset*1.5)}else{var u="-"+t.percent_offset+" -"+t.percent_offset+" "+(i+t.percent_offset*1.6)+" "+(o+t.percent_offset*1.6)}this.set_attr(r,{width:"100%",height:"100%",viewBox:u});return r},identifier:function(e){id=e.data("chart");return"#"+id},throttle:function(e,t){var n=null;return function(){var r=this,i=arguments;clearTimeout(n);n=setTimeout(function(){e.apply(r,i)},t)}},svg_obj:function(e){return document.createElementNS(this.NS,e)},ticks:function(e,t,n){var r=t-e,s=Math.pow(10,Math.floor(Math.log(r/n)/Math.LN10)),o=n/r*s;if(o<=.15)s*=10;else if(o<=.35)s*=5;else if(o<=.75)s*=2;var u=Math.ceil(e/s)*s,a=Math.floor(t/s)*s+s*.5,f=[],l;for(i=u;i<a;i+=s){f.push(i)}return f},set_attr:function(e,t){for(attr in t){e.setAttribute(attr,t[attr])}return this},flip:function(e,t){e.setAttribute("transform","translate(0, "+t+") scale(1, -1)")}};$.extend(Pizza,{bar:function(e){var t=e.data("settings"),n=this.svg(e,t),r=e.data("graph-data"),i=0,s=$(this.identifier(e)),o=s.outerWidth(),u=s.outerHeight(),a=min=0,f=0,l=t.bar_spacer*(t.bar_spacer/o),c=(o-r.length*l)/r.length;if(c<10){l=1;c=(o-r.length*l)/r.length}for(var h=0;h<r.length;h++){if(a<r[h].value)a=r[h].value;if(min>r[h].value)min=r[h].value;f+=r[h].value}var p=$("g[data-id=bars]",n);if(p.length>0){var d=p[0]}else{var d=this.svg_obj("g");d.setAttribute("data-id","bars")}if(t.show_grid){this.assemble_grid(n,min,a,o,u,t)}d.setAttribute("transform","translate(0, "+u+") scale(1, -1)");for(var h=0;h<r.length;h++){var v=u*(r[h].value/a);var m=$("rect[data-id=r"+h+"]",d);if(m.length>0){var g=m[0]}else{var g=this.svg_obj("rect");g.setAttribute("data-id","r"+h)}if(i===0){var y=i}else{var y=i+l}g.setAttribute("data-y",v);this.set_attr(g,{x:y,y:0,width:c,height:v,fill:r[h].color,stroke:t.stroke_color,strokeWidth:t.stroke_width});i=y+c;if(p.length<1){d.appendChild(g)}}if(p.length<1){n.appendChild(d)}return[e,n]},animate_bar:function(e,t,n){var r=this,i=$(e),s=t+15;e.hover(function(e){var t=Snap(e.target);t.animate({height:s},n.animation_speed,mina[n.animation_type])},function(e){var r=Snap(e.target);r.animate({height:t},n.animation_speed,mina[n.animation_type])})},assemble_grid:function(e,t,n,r,s,o){var u=$("g[data-id=bars]",e);if(u.length>0){var a=$("g[data-id=grid]",e)[0],f=$("g[data-id=labels]",e)[0]}else{var a=this.svg_obj("g"),f=this.svg_obj("g");a.setAttribute("data-id","grid");f.setAttribute("data-id","labels")}var l=this.ticks(t,n,o.bar_intervals),c=i=l.length,h=s/(c-1),p=0;while(i--){if(u.length>0){var d=$("line[data-id=l"+i+"]",a)[0],v=$("text[data-id=t"+i+"]",f)[0]}else{var d=this.svg_obj("line"),v=this.svg_obj("text");d.setAttribute("data-id","l"+i);v.setAttribute("data-id","t"+i)}var m=p+h;this.set_attr(d,{x1:0,x2:r,y1:m,y2:m,stroke:"gray","stroke-width":1,"stroke-dasharray":"5,5"}).set_attr(v,{x:-8,y:m+5,"text-anchor":"end"});v.innerHTML=l[i];if(u.length<1){a.appendChild(d);f.appendChild(v)}p=m}a.setAttribute("transform","translate(0, -"+p/c+")");f.setAttribute("transform","translate(0, -"+p/c+")");if(u.length<1){e.appendChild(a);e.appendChild(f)}},bar_events:function(){}});$.extend(Pizza,{line:function(e){var t=e.data("settings"),n=this.svg(e,t),r=$(this.identifier(e)),i=r.outerWidth(),s=r.outerHeight(),o=e.data("graph-data"),u=max_y=min_x=min_y=total_x=total_y=0,a=o.length,f="";for(var a=0;a<o.length;a++){if(o[a].x>u)u=o[a].x;if(o[a].y>max_y)max_y=o[a].y;if(min_x>o[a].x)min_x=o[a].x;if(min_y>o[a].y)min_y=o[a].y;total_x+=o[a].x;total_y+=o[a].y}var l=$("g[data-id=line]",n);if(l.length>0){var c=$("g[data-id=line]",n)[0],h=$("g[data-id=points]",n)[0],p=$("path[data-id=path]",c)[0]}else{var p=this.svg_obj("path"),c=this.svg_obj("g"),h=this.svg_obj("g");c.setAttribute("data-id","line");h.setAttribute("data-id","points");p.setAttribute("data-id","path")}for(var a=0;a<o.length;a++){if(l.length>0){var d=$("circle[data-id=c"+a+"]",h)[0]}else{var d=this.svg_obj("circle");d.setAttribute("data-id","c"+a)}var v=o[a].x/u*i,m=o[a].y/max_y*s;f+=v+","+m+" ";this.set_attr(d,{cx:v,cy:m,r:0,fill:o[a.color],"data-value":o[a].x+", "+o[a].y,"data-tooltip":"",title:o[a].x+", "+o[a].y,"class":"has-tip tip-top"});Snap(d).animate({r:4},1500,mina[t.animation_type]);this.animate(Snap(d),v,m,t,2);if(l.length<1){h.appendChild(d)}}this.flip(h,s);this.flip(c,s);if(t.show_grid){this.assemble_grid_x(n,min_x,u,i,s,t);this.assemble_grid_y(n,min_y,max_y,i,s,t)}var g=this.points_to_path(f);this.set_attr(p,{d:g,fill:"none",stroke:"black","stroke-width":2});if(l.length<1){c.appendChild(p);n.appendChild(c)}if(l.length<1){n.appendChild(h)}return[e,n]},assemble_grid_x:function(e,t,n,r,s,o){var u=$("g[data-id=gridx]",e);if(u.length>0){var a=u[0],f=$("g[data-id=labelx]",e)[0]}else{var a=this.svg_obj("g"),f=this.svg_obj("g");a.setAttribute("data-id","gridx");f.setAttribute("data-id","labelx")}var l=this.ticks(t,n,o.bar_intervals).reverse(),c=i=l.length,h=0,p=r/(c-1);while(i--){if(u.length>0){var d=$("line[data-id=l"+i+"]",a)[0],v=$("text[data-id=t"+i+"]",f)[0]}else{var d=this.svg_obj("line"),v=this.svg_obj("text");d.setAttribute("data-id","l"+i);v.setAttribute("data-id","t"+i)}var m=h+p;this.set_attr(d,{x1:m,x2:m,y1:0,y2:s,stroke:"gray","stroke-width":1,"stroke-dasharray":"5,5"}).set_attr(v,{y:s+20,x:m-p,"text-anchor":"middle"});if(u.length<1){v.innerHTML=l[i];f.appendChild(v);a.appendChild(d)}h=m}a.setAttribute("transform","translate(-"+p+", 0)");if(u.length<1){e.appendChild(a);e.appendChild(f)}},assemble_grid_y:function(e,t,n,r,s,o){var u=$("g[data-id=gridy]",e);if(u.length>0){var a=u[0],f=$("g[data-id=labely]",e)[0]}else{var a=this.svg_obj("g"),f=this.svg_obj("g");a.setAttribute("data-id","gridy");f.setAttribute("data-id","labely")}var l=this.ticks(t,n,o.bar_intervals),c=i=l.length,h=0;while(i--){if(u.length>0){var p=$("line[data-id=l"+i+"]",a)[0],d=$("text[data-id=t"+i+"]",f)[0]}else{var p=this.svg_obj("line"),d=this.svg_obj("text");p.setAttribute("data-id","l"+i);d.setAttribute("data-id","t"+i)}var v=h+s/(c-1);this.set_attr(p,{x1:0,x2:r,y1:v,y2:v,stroke:"gray","stroke-width":1,"stroke-dasharray":"5,5"}).set_attr(d,{x:-8,y:v+5,"text-anchor":"end"});if(u.length<1){f.appendChild(d);a.appendChild(p);d.innerHTML=l[i]}h=v}a.setAttribute("transform","translate(0, -"+h/c+")");f.setAttribute("transform","translate(0, -"+h/c+")");if(u.length<1){e.appendChild(a);e.appendChild(f)}},points_to_path:function(e){var e=e.split(/\s+|,/);var t=e.shift(),n=e.shift();var r="M"+t+","+n+"L"+e.join(" ");return["M"+t+","+n+"L"].concat(e).join(" ")},line_events:function(){$(this.scope).on("mouseenter.pizza mouseleave.pizza touchstart.pizza","[data-chart] li",function(e){var t=$(this).parent(),n=$("#"+t.data("line-id")+' circle[data-id="c'+$(this).index()+'"]')[0],r=$(this).parent().data("settings");if(/start/i.test(e.type)){$(n).siblings("circle").each(function(){if(this.nodeName){Snap(n).animate({transform:"s1 1 "+n.getAttribute("cx")+" "+n.getAttribute("cy")},r.animation_speed,mina[r.animation_type])}})}if(/enter|start/i.test(e.type)){Snap(n).animate({transform:"s2 2 "+n.getAttribute("cx")+" "+n.getAttribute("cy")},r.animation_speed,mina[r.animation_type]);$(n).trigger("mouseenter")}else{Snap(n).animate({transform:"s1 1 "+n.getAttribute("cx")+" "+n.getAttribute("cy")},r.animation_speed,mina[r.animation_type]);$(n).trigger("mouseout")}})}});$.extend(Pizza,{pie:function(e){var t=e.data("settings"),n=this.svg(e,t),r=e.data("graph-data"),i=0,s=[],o=0,u=$(this.identifier(e)),a=u.outerWidth();for(var f=0;f<r.length;f++){i+=r[f].value}for(var f=0;f<r.length;f++){s[f]=r[f].value/i*Math.PI*2}if(s.length==1)s[0]=Math.PI*2-1e-4;for(var f=0;f<r.length;f++){var l=o+s[f];var c=a/2,h=a/2,p=a/2*.85;if(!t.donut){var d=c+p*Math.sin(o);var v=h-p*Math.cos(o);var m=c+p*Math.sin(l);var g=h-p*Math.cos(l);var y=0;if(l-o>Math.PI)y=1;var b="M"+c+","+h+" L"+d+","+v+" A"+p+","+p+" 0 "+y+" 1 "+m+","+g+" Z"}var w=$('path[data-id="s'+f+'"]',n);if(w.length>0){var E=w[0]}else{var E=this.svg_obj("path")}var S=r[f].value/i*100;var x=$('text[data-id="s'+f+'"]',n);if(x.length>0){var T=x[0];T.setAttribute("x",c+(p+t.percent_offset)*Math.sin(o+s[f]/2));T.setAttribute("y",h-(p+t.percent_offset)*Math.cos(o+s[f]/2))}else{if(r[f].text){var N=this.parse_options(r[f].text,S,r[f].value)}else{var N=Math.ceil(S)+"%"}var T=this.svg_obj("text");T.setAttribute("x",c+(p+t.percent_offset)*Math.sin(o+s[f]/2));T.setAttribute("y",h-(p+t.percent_offset)*Math.cos(o+s[f]/2));T.innerHTML=N}T.setAttribute("text-anchor","middle");if(t.always_show_text){Snap(T).animate({opacity:1},t.animation_speed)}else{Snap(T).attr({opacity:0},t.animation_speed)}T.setAttribute("data-id","s"+f);if(t.donut){this.annular_sector(E,{centerX:c,centerY:h,startDegrees:o,endDegrees:l,innerRadius:p*t.donut_inner_ratio,outerRadius:p})}else{E.setAttribute("d",b)}this.set_attr(E,{fill:r[f].color,stroke:t.stroke_color,strokeWidth:t.stroke_width,"data-cx":c,"data-cy":h,"data-id":"s"+f});var C=$("g[data-id=g"+f+"]",n);if(C.length<1){var k=this.svg_obj("g");k.setAttribute("data-id","g"+f);k.appendChild(E);k.appendChild(T);n.appendChild(k);this.animate(Snap(E),c,h,t)}o=l}return[e,n]},annular_sector:function(e,t){function u(e){var t={cx:e.centerX||0,cy:e.centerY||0,startRadians:e.startDegrees||0,closeRadians:e.endDegrees||0};var n=e.thickness!==undefined?e.thickness:100;if(e.innerRadius!==undefined)t.r1=e.innerRadius;else if(e.outerRadius!==undefined)t.r1=e.outerRadius-n;else t.r1=200-n;if(e.outerRadius!==undefined)t.r2=e.outerRadius;else t.r2=t.r1+n;if(t.r1<0)t.r1=0;if(t.r2<0)t.r2=0;return t}var n=u(t);var r=[[n.cx+n.r2*Math.sin(n.startRadians),n.cy-n.r2*Math.cos(n.startRadians)],[n.cx+n.r2*Math.sin(n.closeRadians),n.cy-n.r2*Math.cos(n.closeRadians)],[n.cx+n.r1*Math.sin(n.closeRadians),n.cy-n.r1*Math.cos(n.closeRadians)],[n.cx+n.r1*Math.sin(n.startRadians),n.cy-n.r1*Math.cos(n.startRadians)]];var i=n.closeRadians-n.startRadians;var s=i%(Math.PI*2)>Math.PI?1:0;var o=[];o.push("M"+r[0].join());o.push("A"+[n.r2,n.r2,0,s,1,r[1]].join());o.push("L"+r[2].join());o.push("A"+[n.r1,n.r1,0,s,0,r[3]].join());o.push("z");e.setAttribute("d",o.join(" "))},pie_events:function(){$(this.scope).on("mouseenter.pizza mouseleave.pizza touchstart.pizza","[data-chart] li",function(e){var t=$(this).parent(),n=$("#"+t.attr("data-chart")+' path[data-id="s'+$(this).index()+'"]')[0],r=n.nextSibling,i=$(this).parent().data("settings");if(/start/i.test(e.type)){$(n).siblings("path").each(function(){if(this.nodeName){Snap(n).animate({transform:"s1 1 "+n.getAttribute("data-cx")+" "+n.getAttribute("data-cy")},i.animation_speed,mina[i.animation_type]);Snap($(this).next()[0]).animate({opacity:0},i.animation_speed)}})}if(/enter|start/i.test(e.type)){Snap(n).animate({transform:"s1.05 1.05 "+n.getAttribute("data-cx")+" "+n.getAttribute("data-cy")},i.animation_speed,mina[i.animation_type]);if(i.show_text){Snap(r).animate({opacity:1},i.animation_speed)}}else{Snap(n).animate({transform:"s1 1 "+n.getAttribute("data-cx")+" "+n.getAttribute("data-cy")},i.animation_speed,mina[i.animation_type]);Snap(r).animate({opacity:0},i.animation_speed)}})}})
